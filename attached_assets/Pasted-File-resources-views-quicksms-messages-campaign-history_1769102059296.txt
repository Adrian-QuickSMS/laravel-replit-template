File: resources/views/quicksms/messages/campaign-history.blade.php (JavaScript section)

PROBLEM:
When clicking "Suspend Campaign" or "Cancel Campaign" from the three-dot menu:
1. The confirmation modal never appears
2. The campaign status badge doesn't update after confirmation
3. No errors appear in console

ROOT CAUSE:
The variable campaignActionModal is being checked (if (!campaignActionModal)) but was never properly declared in global scope, causing a ReferenceError that fails silently. Also, dropdowns aren't being closed properly using Bootstrap's API.

SOLUTION:

STEP 1: Add global variable declarations at the TOP of the <script> section:

var campaignActionModal = null;
var pendingCampaignAction = null;

STEP 2: Replace the handleCampaignAction function:

function handleCampaignAction(event, action, campaignId) {
    event.preventDefault();
    event.stopPropagation();
    
    console.log('[Campaign Action] Action:', action, 'ID:', campaignId);
    
    // Close all dropdowns properly using Bootstrap API
    document.querySelectorAll('.dropdown-menu.show').forEach(function(menu) {
        var toggle = menu.previousElementSibling;
        if (toggle) {
            var dropdown = bootstrap.Dropdown.getInstance(toggle);
            if (dropdown) {
                dropdown.hide();
            }
        }
    });
    
    // Small delay to let dropdown close
    setTimeout(function() {
        switch(action) {
            case 'suspend':
                confirmSuspendCampaign(campaignId);
                break;
            case 'cancel':
                confirmCancelCampaign(campaignId);
                break;
        }
    }, 150);
}

STEP 3: Replace the confirmSuspendCampaign function:

function confirmSuspendCampaign(campaignId) {
    console.log('[Modal] Opening suspend modal for campaign:', campaignId);
    
    var campaign = getCampaignData(campaignId);
    if (!campaign) {
        console.error('[Modal] Campaign not found:', campaignId);
        return;
    }
    
    pendingCampaignAction = { 
        action: 'suspend', 
        campaignId: campaignId, 
        campaign: campaign 
    };
    
    // Set up modal content
    document.getElementById('actionModalTitle').textContent = 'Suspend Campaign';
    document.getElementById('actionModalBody').innerHTML = 
        '<div class="alert alert-warning mb-3">' +
            '<i class="fas fa-exclamation-triangle me-2"></i>' +
            '<strong>Warning:</strong> This will pause message delivery immediately.' +
        '</div>' +
        '<p class="mb-2">Campaign: <strong>' + escapeHtml(campaign.name) + '</strong></p>' +
        '<div class="mb-3">' +
            '<label for="actionReason" class="form-label">Reason for suspension:</label>' +
            '<textarea id="actionReason" class="form-control" rows="3" placeholder="Enter reason for suspending this campaign..."></textarea>' +
        '</div>';
    
    var modalEl = document.getElementById('campaignActionModal');
    if (!modalEl) {
        console.error('[Modal] Modal element not found: campaignActionModal');
        return;
    }
    
    // Dispose existing instance if any
    if (campaignActionModal) {
        campaignActionModal.dispose();
    }
    
    // Create new modal instance
    campaignActionModal = new bootstrap.Modal(modalEl);
    campaignActionModal.show();
    console.log('[Modal] Suspend modal shown');
}

STEP 4: Replace the confirmCancelCampaign function (similar pattern):

function confirmCancelCampaign(campaignId) {
    console.log('[Modal] Opening cancel modal for campaign:', campaignId);
    
    var campaign = getCampaignData(campaignId);
    if (!campaign) {
        console.error('[Modal] Campaign not found:', campaignId);
        return;
    }
    
    pendingCampaignAction = { 
        action: 'cancel', 
        campaignId: campaignId, 
        campaign: campaign 
    };
    
    document.getElementById('actionModalTitle').textContent = 'Cancel Campaign';
    document.getElementById('actionModalBody').innerHTML = 
        '<div class="alert alert-danger mb-3">' +
            '<i class="fas fa-ban me-2"></i>' +
            '<strong>Warning:</strong> This action cannot be undone. The campaign will be permanently cancelled.' +
        '</div>' +
        '<p class="mb-2">Campaign: <strong>' + escapeHtml(campaign.name) + '</strong></p>' +
        '<div class="mb-3">' +
            '<label for="actionReason" class="form-label">Reason for cancellation:</label>' +
            '<textarea id="actionReason" class="form-control" rows="3" placeholder="Enter reason for cancelling this campaign..."></textarea>' +
        '</div>';
    
    var modalEl = document.getElementById('campaignActionModal');
    if (!modalEl) {
        console.error('[Modal] Modal element not found: campaignActionModal');
        return;
    }
    
    if (campaignActionModal) {
        campaignActionModal.dispose();
    }
    
    campaignActionModal = new bootstrap.Modal(modalEl);
    campaignActionModal.show();
    console.log('[Modal] Cancel modal shown');
}

STEP 5: Replace the executeCampaignAction function:

function executeCampaignAction() {
    if (!pendingCampaignAction) {
        console.error('[Action] No pending action');
        return;
    }
    
    var reason = document.getElementById('actionReason').value.trim();
    var action = pendingCampaignAction.action;
    var campaign = pendingCampaignAction.campaign;
    
    console.log('[Action] Executing:', action, 'for campaign:', campaign.id);
    
    // Find the row
    var row = document.querySelector('tr[data-id="' + campaign.id + '"]');
    if (!row) {
        console.error('[Action] Row not found for campaign:', campaign.id);
        return;
    }
    
    // Update row status
    var statusCell = row.querySelector('.status-cell');
    var actionsCell = row.querySelector('.actions-cell');
    
    if (action === 'suspend') {
        row.dataset.status = 'suspended';
        if (statusCell) {
            statusCell.innerHTML = '<span class="badge badge-pastel-warning"><i class="fas fa-pause me-1"></i>Suspended</span>';
        }
        
        if (actionsCell) {
            actionsCell.querySelector('.dropdown-menu').innerHTML = 
                '<li><a class="dropdown-item" href="#" onclick="handleCampaignAction(event, \'resume\', \'' + campaign.id + '\')">' +
                    '<i class="fas fa-play me-2"></i>Resume Campaign' +
                '</a></li>' +
                '<li><a class="dropdown-item" href="#" onclick="handleCampaignAction(event, \'view\', \'' + campaign.id + '\')">' +
                    '<i class="fas fa-eye me-2"></i>View Details' +
                '</a></li>';
        }
    } else if (action === 'cancel') {
        row.dataset.status = 'cancelled';
        if (statusCell) {
            statusCell.innerHTML = '<span class="badge badge-pastel-danger"><i class="fas fa-ban me-1"></i>Cancelled</span>';
        }
        
        if (actionsCell) {
            actionsCell.querySelector('.dropdown-menu').innerHTML = 
                '<li><a class="dropdown-item" href="#" onclick="handleCampaignAction(event, \'view\', \'' + campaign.id + '\')">' +
                    '<i class="fas fa-eye me-2"></i>View Details' +
                '</a></li>';
        }
    }
    
    if (campaignActionModal) {
        campaignActionModal.hide();
    }
    
    pendingCampaignAction = null;
    console.log('[Action] Status updated successfully');
}

STEP 6: Add escapeHtml helper function (if it doesn't exist):

function escapeHtml(text) {
    if (!text) return '';
    var map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return String(text).replace(/[&<>"']/g, function(m) { return map[m]; });
}

STEP 7: Ensure the modal HTML exists in the Blade template:

<div class="modal fade" id="campaignActionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="actionModalTitle">Confirm Action</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="actionModalBody">
                <!-- Content injected by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="executeCampaignAction()">Confirm</button>
            </div>
        </div>
    </div>
</div>

WHY THIS WORKS:
✅ Declares campaignActionModal globally so it's accessible across functions
✅ Properly disposes old modal instances before creating new ones
✅ Closes dropdowns using Bootstrap API instead of manual class manipulation
✅ Adds comprehensive console logging for debugging
✅ Updates both the status badge AND the dropdown menu options
✅ Updates data-status attribute on the row for proper filtering
✅ Adds HTML escaping for security

RESULT:
Clicking "Suspend" or "Cancel" will now show the confirmation modal, and after confirming, the status badge will update correctly and the actions menu will rebuild with appropriate options.
